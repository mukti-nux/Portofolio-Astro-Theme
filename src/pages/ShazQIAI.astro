---
import Layout from "../layouts/Layout.astro";
import Container from "../components/Container.astro";
---

<Layout title="ShazQIAI">
  <div class="pt-36">
    <Container>
      <!-- ChatBoxStart -->
      <div class="relative max-w-2xl mx-auto mt-16 rounded-xl p-6 bg-white dark:bg-gray-900 shadow-lg transition-all duration-300 border border-transparent hover:border-[3px] hover:border-[rgb(0,255,255)] group">
        <!-- Gradient Glow Border -->
        <div class="absolute inset-0 animate-gradient-move bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 
              bg-[length:200%_200%] bg-[position:0%_50%] blur-lg opacity-80 rounded-xl z-[-1]"></div>

        <!-- Chat Content -->
        <div id="chat-messages" class="mb-4 space-y-3 max-h-64 overflow-y-auto text-gray-900 dark:text-white text-sm">
          <div class="text-left">ðŸ¤– Halo! Ada yang bisa aku bantu?</div>
        </div>

        <!-- Input -->
        <form id="chat-form" class="flex space-x-2">
          <input
            id="chat-input"
            class="flex-1 rounded-md p-2 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="Tulis pertanyaanmu..."
          />
          <button type="submit" class="bg-primary text-white px-4 py-2 rounded-md hover:brightness-110 transition">
            Kirim
          </button>
        </form>
      </div>
      <!-- ChatBoxEnd -->
    </Container>
  </div>

  <script is:inline>
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const messages = document.getElementById('chat-messages');
    const history = ["AI: Halo! Ada yang bisa aku bantu?"]; // ðŸ§  simpan riwayat

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      // Simpan pesan user ke history
      history.push(`User: ${text}`);

      const userMsg = document.createElement('div');
      userMsg.textContent = "ðŸ§‘ " + text;
      userMsg.className = "text-left";
      messages.appendChild(userMsg);

      input.value = "";

      const botMsg = document.createElement('div');
      botMsg.textContent = "ðŸ¤– Sedang mengetik...";
      botMsg.className = "text-left italic text-gray-500";
      messages.appendChild(botMsg);
      messages.scrollTop = messages.scrollHeight;

      try {
        const res = await fetch('https://shazqi-ai-backend-deploy.vercel.app/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: history.join("\n") }) // kirim riwayat
        });

        const { reply } = await res.json();
        botMsg.textContent = "ðŸ¤– " + reply;
        botMsg.classList.remove("italic", "text-gray-500");

        // Simpan balasan AI ke history
        history.push(`AI: ${reply}`);
      } catch (err) {
        botMsg.textContent = "ðŸ¤– Maaf, terjadi kesalahan.";
        botMsg.classList.remove("italic", "text-gray-500");
        botMsg.classList.add("text-red-500");
      }

      messages.scrollTop = messages.scrollHeight;
    });
  </script>
</Layout>
